<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘çš„æº«é¦¨è¨˜å¸³æœ¬ ğŸ» (é›²ç«¯ç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg-color: #FFF9F0;
            --card-bg: #FFFFFF;
            --primary-pink: #FFB7B2;
            --secondary-yellow: #FFF2CC;
            --accent-green: #B5EAD7;
            --edit-orange: #FFCC80;
            --text-color: #6D4C41;
            --border-radius: 20px;
            --tab-inactive: #FFE0B2;
            --tab-active: #FF9AA2;
            --income-color: #558B2F;
            --expense-color: #FF6F61;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 15px;
            background-image: 
                linear-gradient(#FFE0B2 1px, transparent 1px),
                linear-gradient(90deg, #FFE0B2 1px, transparent 1px);
            background-size: 30px 30px;
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(109, 76, 65, 0.08);
            border: 4px solid white;
            position: relative;
        }

        .settings-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            opacity: 0.6;
            transition: 0.3s;
        }
        .settings-btn:hover { opacity: 1; transform: rotate(90deg); }

        header { text-align: center; margin-bottom: 20px; }
        h1 { color: #FF8B94; font-size: 2.2em; text-shadow: 2px 2px 0px #FFF2CC; margin-bottom: 5px; letter-spacing: 1px; }
        .mascot { font-size: 3em; display: block; margin-bottom: 5px; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* åˆ†é å°èˆª */
        .nav-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .tab-btn {
            padding: 10px 25px; font-size: 1.1em; border: none; border-radius: 30px; cursor: pointer;
            font-family: inherit; font-weight: bold; transition: all 0.3s ease;
            background-color: var(--tab-inactive); color: #8D6E63; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            flex: 1; max-width: 180px; white-space: nowrap;
        }
        .tab-btn.active { background-color: var(--tab-active); color: white; box-shadow: 0 4px 10px rgba(255, 154, 162, 0.4); transform: translateY(-2px); }
        .view-section { display: none; animation: fadeIn 0.5s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¼¸å…¥å€å¡Š & Edit Mode Style */
        .input-box {
            background-color: var(--secondary-yellow);
            padding: 20px; border-radius: var(--border-radius); border: 3px dashed #FFB7B2;
            margin-bottom: 25px; position: relative; transition: 0.3s;
        }
        .input-box.editing {
            border-color: var(--edit-orange);
            background-color: #FFF8E1;
            box-shadow: 0 0 15px rgba(255, 204, 128, 0.3);
        }

        /* Loading */
        .loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); border-radius: var(--border-radius);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; backdrop-filter: blur(5px); text-align: center; padding: 20px; box-sizing: border-box;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid #FF9AA2; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        .progress-bar { width: 80%; height: 10px; background-color: #eee; border-radius: 5px; margin-top: 15px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background-color: #B5EAD7; transition: width 0.3s; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ”¶æ”¯åˆ‡æ› */
        .type-switch-container { display: flex; justify-content: center; margin-bottom: 20px; }
        .type-switch { display: flex; background: transparent; width: 100%; max-width: 400px; gap: 15px; }
        .type-option {
            flex: 1; display: flex; align-items: center; justify-content: center; gap: 5px; cursor: pointer;
            font-weight: bold; font-size: 1.2em; padding: 12px 0; border-radius: 20px; transition: all 0.2s ease;
            color: #8D6E63; background-color: rgba(255, 255, 255, 0.6); border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .type-option input { display: none; }
        .type-option.selected-expense { background-color: #FFCDD2; color: #c62828; border-color: #EF9A9A; box-shadow: 0 4px 10px rgba(229, 115, 115, 0.3); transform: translateY(-2px); }
        .type-option.selected-income { background-color: #C8E6C9; color: #2E7D32; border-color: #A5D6A7; box-shadow: 0 4px 10px rgba(129, 199, 132, 0.3); transform: translateY(-2px); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #8D6E63; font-size: 0.9em; }
        
        /* çµ±ä¸€æ¬„ä½æ¨£å¼èˆ‡é«˜åº¦ (å¼·åˆ¶å°é½Š) */
        input:not([type="checkbox"]):not([type="radio"]), select {
            width: 100%; 
            height: 48px !important; /* å¼·åˆ¶å›ºå®šé«˜åº¦ */
            line-height: normal; /* ä¿®å¾©éƒ¨åˆ†ç€è¦½å™¨å°é½Šå•é¡Œ */
            padding: 0 12px; 
            border: 2px solid #FFE0B2; 
            border-radius: 12px; 
            box-sizing: border-box;
            font-family: inherit; 
            font-size: 1rem; 
            color: var(--text-color); 
            background: white; 
            transition: 0.3s; 
            -webkit-appearance: none;
            display: flex;
            align-items: center;
        }
        input:focus, select:focus { outline: none; border-color: #FFB7B2; box-shadow: 0 0 0 3px rgba(255, 183, 178, 0.2); }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { grid-column: 1 / -1; display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        button {
            flex: 1; padding: 12px; border: none; border-radius: 15px; font-size: 1.1em; cursor: pointer;
            font-weight: bold; transition: transform 0.1s, box-shadow 0.1s; font-family: inherit;
            display: flex; align-items: center; justify-content: center; gap: 5px; min-width: 100px;
        }
        button:active { transform: scale(0.98); box-shadow: none !important; transform: translateY(4px) !important; }

        .btn-add { background-color: #FF9AA2; color: white; box-shadow: 0 4px 0 #E57373; flex: 1.2; }
        .btn-update { background-color: var(--edit-orange); color: #E65100; box-shadow: 0 4px 0 #FB8C00; flex: 1.5; }
        .btn-export { background-color: var(--accent-green); color: #558B2F; box-shadow: 0 4px 0 #81C784; }
        .btn-clear { background-color: #ECEFF1; color: #78909C; box-shadow: 0 4px 0 #CFD8DC; }
        .btn-cancel-edit { background-color: #E0E0E0; color: #616161; box-shadow: 0 4px 0 #BDBDBD; display: none; }
        .btn-ocr { background-color: #9FA8DA; color: white; box-shadow: 0 4px 0 #7986CB; }
        #ocrInput { display: none; }

        /* Dashboard (Modified for 4 cards) */
        .summary-dashboard { 
            display: flex; 
            gap: 10px; 
            margin: 0 0 20px 0; 
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
        }
        .summary-card { 
            flex: 1; 
            min-width: 120px; /* ç¢ºä¿æœ€å°å¯¬åº¦ï¼Œé¿å…å¤ªæ“  */
            padding: 15px 10px; 
            border-radius: 15px; 
            text-align: center; 
            border: 2px solid transparent; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); 
        }
        .card-income { background-color: #F1F8E9; color: var(--income-color); border-color: #DCEDC8; }
        .card-expense { background-color: #FFEBEE; color: var(--expense-color); border-color: #FFCDD2; }
        .card-balance { background-color: #E3F2FD; color: #1565C0; border-color: #BBDEFB; }
        /* æ–°å¢ï¼šä»Šæ—¥èŠ±è²»å¡ç‰‡æ¨£å¼ */
        .card-today { background-color: #FFF3E0; color: #E65100; border-color: #FFE0B2; }

        .summary-label { font-size: 0.85em; opacity: 0.8; margin-bottom: 5px; font-weight: bold; }
        .summary-value { font-size: 1.2em; font-weight: 800; letter-spacing: 0.5px; word-break: break-all; }

        /* List */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #FFF2CC; padding: 10px 15px; border-radius: 15px; }
        .list-header h3 { margin: 0; font-size: 1.2em; color: #8D6E63; }
        .list-header select { width: auto; padding: 0 15px; height: 36px !important; border-radius: 20px; font-size: 0.9em; background: white; border: 1px solid #FFE0B2; }
        .table-container { overflow-x: auto; border-radius: 15px 15px 0 0; min-height: 200px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; background: white; }
        th { background-color: #FFDAC1; color: #6D4C41; padding: 15px; text-align: left; position: sticky; top: 0; z-index: 10; font-size: 1em; }
        td { padding: 12px 15px; border-bottom: 2px solid #FFF8E1; color: #555; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        .cost-text { font-weight: bold; font-size: 1.1em; }
        .cost-expense { color: var(--expense-color); }
        .cost-income { color: var(--income-color); }

        /* æ–°å¢ï¼šæ“ä½œæŒ‰éˆ•æ¬„ä½å°ˆç”¨æ¨£å¼ */
        .action-cell {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px; /* æŒ‰éˆ•ä¹‹é–“çš„é–“è· */
        }

        .btn-delete { background-color: #FFEBEE; color: #C62828; padding: 6px 12px; font-size: 0.9em; box-shadow: none; flex: none; width: auto; border-radius: 10px; }
        .btn-edit { background-color: #FFF9C4; color: #F57F17; padding: 6px 12px; font-size: 0.9em; box-shadow: none; flex: none; width: auto; border-radius: 10px; }

        /* ä¿®æ”¹ï¼šé ç¢¼æ¨£å¼ (ç”±åœ“å½¢æ”¹ç‚ºåœ“è§’çŸ©å½¢) */
        .pagination { display: flex; justify-content: center; gap: 5px; padding: 15px; background: white; border-radius: 0 0 15px 15px; border-top: 1px solid #FFF8E1; }
        .page-btn { 
            min-width: 35px; height: 35px; 
            border-radius: 8px; /* é€™è£¡æ”¹ç‚º 8px è®“å®ƒè®Šæ–¹ */
            border: 1px solid #FFE0B2; background: white; color: #8D6E63; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; padding: 0 5px; box-shadow: none; 
        }
        .page-btn:hover { background-color: #FFF8E1; }
        .page-btn.active { background-color: #FFB7B2; color: white; border-color: #FF8A80; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Stats Styles */
        .stats-controls { display: flex; justify-content: space-between; align-items: stretch; background-color: #FFF2CC; padding: 20px; border-radius: 20px; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .control-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 120px; }
        .control-group-toggle { flex: 0 0 auto; min-width: auto; display: flex; flex-direction: column; justify-content: flex-end; }
        .toggle-switch { display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; background-color: #FFF; padding: 0 15px; border-radius: 12px; border: 2px solid #FFE0B2; color: #8D6E63; font-weight: bold; transition: all 0.3s ease; user-select: none; height: 48px; box-sizing: border-box; white-space: nowrap; }
        .toggle-switch.active { background-color: #FFB7B2; color: white; border-color: #FF8A80; }
        .toggle-switch input { display: none; }
        .toggle-icon { font-size: 1.2em; }
        .stats-card { background: white; border: 2px solid #FFF8E1; border-radius: 20px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stats-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .category-name { font-weight: bold; width: 45%; font-size: 1em; }
        .bar-container { flex: 1; background-color: #F5F5F5; height: 12px; border-radius: 6px; margin: 0 10px; overflow: hidden; }
        .bar-fill { height: 100%; background-color: #FFB7B2; border-radius: 7px; transition: width 1s ease; }
        .bar-fill.income-bar { background-color: #AED581; }
        .category-amount { width: 25%; text-align: right; font-weight: bold; font-size: 1em; }
        .empty-state { text-align: center; padding: 50px 20px; color: #BBB; font-size: 1.1em; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(60, 40, 40, 0.6); backdrop-filter: blur(5px); }
        .modal-content { background-color: #FFF; margin: 5% auto; padding: 20px; border: none; border-radius: 20px; width: 90%; max-width: 850px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative; }
        .modal-header { text-align: center; margin-bottom: 15px; border-bottom: 2px dashed #FFE0B2; padding-bottom: 10px; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 2px; }
        .receipt-row { display: grid; grid-template-columns: 2fr 1fr 1.5fr 0.5fr; gap: 8px; margin-bottom: 10px; align-items: center; padding: 10px; background: #FAFAFA; border-radius: 12px; border: 1px solid #EEE; }
        .receipt-row input, .receipt-row select { padding: 0 8px; height: 40px !important; font-size: 0.9em; margin: 0; border: 1px solid #E0E0E0; }
        .receipt-actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn-add-row { background-color: #E1F5FE; color: #0277BD; padding: 12px; margin-top: 10px; width: 100%; border-radius: 12px; border: 2px dashed #81D4FA; cursor: pointer; font-weight: bold; }
        .receipt-info-bar { background-color: #FFF3E0; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap; }
        .settings-input { width: 100%; padding: 0 12px; height: 48px !important; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 1rem; }

        .btn-confirm { background-color: #AED581; color: #33691E; box-shadow: 0 4px 0 #7CB342; }
        .btn-test { background-color: #81D4FA; color: #01579B; box-shadow: 0 4px 0 #29B6F6; }
        .btn-cancel { background-color: #FFCCBC; color: #BF360C; box-shadow: 0 4px 0 #FF8A65; }

        @media (max-width: 768px) {
            body { padding: 10px; background-size: 20px 20px; }
            .container { padding: 15px; border-width: 3px; }
            h1 { font-size: 1.8em; margin-bottom: 5px; }
            .mascot { font-size: 2.5em; }
            .form-grid { grid-template-columns: 1fr; gap: 10px; }
            input, select, .tab-btn, .btn-ocr, .type-option { font-size: 1rem; }
            .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .btn-ocr { grid-column: 1 / 2; order: 1; } .btn-clear { grid-column: 2 / 3; order: 2; }
            .btn-export { grid-column: 1 / 2; order: 3; } .btn-add, .btn-update { grid-column: 2 / 3; order: 4; }
            .btn-cancel-edit { grid-column: 1 / 2; order: 5; }
            .stats-controls { flex-direction: column; gap: 10px; padding: 15px; }
            .control-group, .control-group-toggle { width: 100%; }
            .toggle-switch { width: 100%; justify-content: center; }
            .summary-label { font-size: 0.8em; } .summary-value { font-size: 1.1em; }
            /* Mobile: Make summary cards 2x2 grid */
            .summary-card { min-width: 40%; flex: 1 1 40%; }
            .receipt-row { grid-template-columns: 1fr 1fr 0.5fr; grid-template-rows: auto auto; gap: 8px; }
            .receipt-row input.item-name { grid-column: 1 / -1; } .receipt-row input.item-price { grid-column: 1 / 2; } .receipt-row select.item-cat { grid-column: 2 / 3; } .receipt-row button { grid-column: 3 / 4; padding: 5px; height: 100%; }
            .receipt-info-bar { flex-direction: column; gap: 10px; } .receipt-info-bar > div { width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <button class="settings-btn" onclick="openSettings()">âš™ï¸</button>
    <header>
        <span class="mascot">ğŸ» ğŸ“ ğŸ°</span>
        <h1>æˆ‘çš„å¯æ„›è¨˜å¸³æœ¬</h1>
        <p>é›²ç«¯åŒæ­¥ç‰ˆ (Google Sheet)</p>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('input')">ğŸ“ è¨˜å¸³è¼¸å…¥</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š çµ±è¨ˆå ±è¡¨</button>
    </div>

    <!-- é é¢ 1: è¨˜å¸³è¼¸å…¥ -->
    <div id="view-input" class="view-section active">
        <div class="summary-dashboard">
            <!-- æ–°å¢ï¼šä»Šæ—¥èŠ±è²»å¡ç‰‡ -->
            <div class="summary-card card-today"><div class="summary-label">ä»Šæ—¥èŠ±è²»</div><div class="summary-value" id="dashToday">$0</div></div>
            <div class="summary-card card-income"><div class="summary-label"><span id="dashLabel">æœ¬æœˆ</span>æ”¶å…¥</div><div class="summary-value" id="dashIncome">$0</div></div>
            <div class="summary-card card-expense"><div class="summary-label"><span id="dashLabelExp">æœ¬æœˆ</span>æ”¯å‡º</div><div class="summary-value" id="dashExpense">$0</div></div>
            <div class="summary-card card-balance"><div class="summary-label">çµé¤˜</div><div class="summary-value" id="dashBalance">$0</div></div>
        </div>

        <div class="input-box" id="inputFormBox">
            <div id="loadingOverlay" class="loading-overlay">
                <div class="spinner"></div><div id="loadingText" style="font-weight:bold; color: #7986CB;">è³‡æ–™è™•ç†ä¸­...</div>
                <div class="progress-bar" id="ocrProgressContainer" style="display:none;"><div id="ocrProgress" class="progress-fill"></div></div>
            </div>

            <form id="accountingForm">
                <div class="type-switch-container">
                    <div class="type-switch">
                        <label class="type-option selected-expense" id="labelExpense">
                            <input type="radio" name="type" value="expense" checked onchange="toggleType('expense')">ğŸ’¸ æ”¯å‡º
                        </label>
                        <label class="type-option" id="labelIncome">
                            <input type="radio" name="type" value="income" onchange="toggleType('income')">ğŸ’° æ”¶å…¥
                        </label>
                    </div>
                </div>

                <div class="form-grid">
                    <div><label>ğŸ“… æ—¥æœŸ</label><input type="date" id="date" required></div>
                    <div><label>ğŸ·ï¸ åˆ†é¡é …ç›®</label><select id="category" required></select></div>
                    <div><label>ğŸ“ èªªæ˜ (å“é …)</label><input type="text" id="description" placeholder="ä¾‹å¦‚ï¼šé›è…¿é£¯..." required></div>
                    <div><label>ğŸ’µ é‡‘é¡ (å…ƒ)</label><input type="number" id="cost" placeholder="0" required></div>
                    <div><label>ğŸ’³ æ–¹å¼</label><select id="method"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option></select></div>
                    <div><label>ğŸ“Œ å‚™è¨»</label><input type="text" id="note" placeholder="å‚™è¨»..."></div>
                    
                    <div class="btn-group">
                        <input type="file" id="ocrInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                        <button type="button" class="btn-ocr" id="btnImportReceipt" onclick="document.getElementById('ocrInput').click()">åŒ¯å…¥ç™¼ç¥¨</button>
                        <button type="button" class="btn-clear" onclick="clearForm()">æ¸…é™¤</button>
                        <button type="button" class="btn-export" onclick="exportToCSV()">åŒ¯å‡º Excel</button>
                        <button type="button" class="btn-cancel-edit" id="btnCancelEdit" onclick="cancelEdit()">å–æ¶ˆä¿®æ”¹</button>
                        <button type="submit" class="btn-add" id="btnSubmit">æ–°å¢</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="list-header">
            <h3>ğŸ“œ æ”¶æ”¯æ˜ç´°</h3>
            <select id="listFilterMonth" onchange="window.currentListPage=1; renderTable()"><option value="all">é¡¯ç¤ºå…¨éƒ¨</option></select>
        </div>

        <div class="table-container">
            <table id="expenseTable">
                <thead><tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>åˆ†é¡</th><th>èªªæ˜</th><th>é‡‘é¡</th><th>æ–¹å¼</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        <div class="pagination" id="listPagination"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><h2>âš™ï¸ é€£ç·šè¨­å®š</h2><p>è«‹ç¢ºèªæ‚¨çš„ Google Apps Script ç¶²å€</p></div>
            <div class="modal-body">
                <input type="text" id="apiUrlInput" class="settings-input" placeholder="è«‹è²¼ä¸Šæ‚¨çš„ Web App URL (çµå°¾é€šå¸¸æ˜¯ /exec)" />
                <p style="font-size: 0.9em; color: #888; line-height: 1.6;">
                    <strong>âš ï¸ è¨­å®šæª¢æŸ¥æ¸…å–®ï¼š</strong><br>
                    1. ç¶²å€å¿…é ˆä»¥ <code>/exec</code> çµå°¾ã€‚<br>
                    2. éƒ¨ç½²æ™‚ã€Œèª°å¯ä»¥å­˜å–ã€å‹™å¿…é¸ <strong>ã€Œä»»ä½•äºº (Anyone)ã€</strong>ã€‚<br>
                    3. è«‹é¿å…ä½¿ç”¨ã€Œç„¡ç—•æ¨¡å¼ã€æˆ–é˜»æ“‹ç¬¬ä¸‰æ–¹ Cookie çš„ç€è¦½å™¨ï¼Œé€™å¯èƒ½æœƒå½±éŸ¿ Google é©—è­‰ã€‚<br>
                    4. æ¯æ¬¡ä¿®æ”¹ Apps Script å¾Œï¼Œè¨˜å¾—æŒ‰ã€Œæ–°ç‰ˆæœ¬ã€éƒ¨ç½²ã€‚
                </p>
            </div>
            <div class="receipt-actions">
                <button class="btn-test" onclick="testConnection()">ğŸ§ª æ¸¬è©¦é€£ç·š</button>
                <button class="btn-confirm" onclick="saveSettings()">å„²å­˜è¨­å®š</button>
                <button class="btn-cancel" onclick="closeSettings()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Receipt Modal & Stats View -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h2>ğŸ§¾ ç™¼ç¥¨æ˜ç´°ç¢ºèª</h2></div>
            <div class="receipt-info-bar"><div style="flex:1;"><label>æ—¥æœŸ</label><input type="date" id="modalDate"></div><div style="flex:1;"><label>ä»˜æ¬¾</label><select id="modalMethod"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option></select></div></div>
            <div class="modal-body"><div id="receiptItemsList"></div><button type="button" class="btn-add-row" onclick="addNewReceiptRow()">+ æ–°å¢ä¸€åˆ—</button></div>
            <div class="receipt-actions"><button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn-confirm" onclick="importReceiptItems()">âœ… ç¢ºèªåŒ¯å…¥</button></div>
        </div>
    </div>

    <div id="view-stats" class="view-section">
        <div class="stats-controls">
            <div class="control-group"><label>ğŸ“… å¹´ä»½</label><select id="statsYearSelect" onchange="updateMonthOptions()"></select></div>
            <div class="control-group"><label>ğŸ—“ï¸ æœˆä»½</label><select id="statsMonthSelect" onchange="renderStats()"><option value="all">å…¨éƒ¨</option></select></div>
            <div class="control-group-toggle"><label class="toggle-switch" id="excludeLabel"><input type="checkbox" id="excludeLarge" onchange="toggleExcludeStyle(); renderStats()"><span class="toggle-icon">ğŸ‘ï¸</span><span>æ’é™¤å¹´åº¦æ”¯å‡º</span></label></div>
        </div>
        <div class="summary-dashboard">
            <div class="summary-card card-income"><div class="summary-label">ç¸½æ”¶å…¥</div><div class="summary-value" id="statsTotalIncome">$0</div></div>
            <div class="summary-card card-expense"><div class="summary-label">ç¸½æ”¯å‡º</div><div class="summary-value" id="statsTotalExpense">$0</div></div>
            <div class="summary-card card-balance"><div class="summary-label">ç¸½çµé¤˜</div><div class="summary-value" id="statsBalance">$0</div></div>
        </div>
        <div id="statsList"></div>
    </div>
</div>

<script>
    // --- Config & Init ---
    let API_URL = localStorage.getItem('myCuteAccountBook_API') || '';
    let transactions = [];
    window.currentListPage = 1;
    const itemsPerPage = 20; 
    let currentEditingId = null; 

    const expenseCategoriesHTML = `<optgroup label="ğŸ” é£Ÿ"><option value="é£Ÿâ€“æ—©é¤">é£Ÿâ€“æ—©é¤</option><option value="é£Ÿâ€“åˆé¤">é£Ÿâ€“åˆé¤</option><option value="é£Ÿâ€“æ™šé¤">é£Ÿâ€“æ™šé¤</option><option value="é£Ÿâ€“æ—©åˆèŒ¶">é£Ÿâ€“æ—©åˆèŒ¶</option><option value="é£Ÿâ€“é»å¿ƒ">é£Ÿâ€“é»å¿ƒ</option><option value="é£Ÿâ€“é£²æ–™">é£Ÿâ€“é£²æ–™</option><option value="é£Ÿâ€“é£Ÿæ" selected>é£Ÿâ€“é£Ÿæ</option></optgroup><optgroup label="ğŸ‘— è¡£"><option value="è¡£â€“é‹è¥ª/åŒ…åŒ…/è¡£æœ">è¡£â€“é‹è¥ª/åŒ…åŒ…/è¡£æœ</option></optgroup><optgroup label="ğŸ’‡â€â™€ï¸ ç¾"><option value="ç¾â€“ç¾é«®">ç¾â€“ç¾é«®</option><option value="ç¾â€“ä¿é¤Šå“">ç¾â€“ä¿é¤Šå“</option></optgroup><optgroup label="ğŸ  ä½"><option value="ä½â€“æ‰‹æ©Ÿè²»">ä½â€“æ‰‹æ©Ÿè²»</option></optgroup><optgroup label="ğŸš— è¡Œ"><option value="è¡Œâ€“ç¶­ä¿®/åœè»Š">è¡Œâ€“ç¶­ä¿®/åœè»Š</option><option value="è¡Œâ€“åŠ æ²¹">è¡Œâ€“åŠ æ²¹</option></optgroup><optgroup label="âœï¸ è‚²"><option value="è‚²â€“æ–‡å…·">è‚²â€“æ–‡å…·</option><option value="è‚²â€“æ›¸/ä¸Šèª²å­¸ç¿’">è‚²â€“æ›¸/ä¸Šèª²å­¸ç¿’</option></optgroup><optgroup label="ğŸ¡ æ¨‚"><option value="æ¨‚â€“ä½å®¿/é–€ç¥¨/äº¤é€š">æ¨‚â€“ä½å®¿/é–€ç¥¨/äº¤é€š</option></optgroup><optgroup label="ğŸ‘¶ BABY"><option value="BABY-è¡£ç‰©">BABY-è¡£ç‰©</option><option value="BABY-ç”¨ç‰©">BABY-ç”¨ç‰©</option><option value="BABY-é†«ç™‚">BABY-é†«ç™‚</option></optgroup><optgroup label="ğŸ›’ å…¶ä»–"><option value="å…¶ä»–â€“æ—¥ç”¨é›œè²¨" selected>å…¶ä»–â€“æ—¥ç”¨é›œè²¨</option><option value="å…¶ä»–â€“æ—¥ç”¨é›œè²¨(å®¶ç”¨)">å…¶ä»–â€“æ—¥ç”¨é›œè²¨(å®¶ç”¨)</option><option value="å…¶ä»–â€“é†«ç™‚">å…¶ä»–â€“é†«ç™‚</option><option value="å…¶ä»–â€“ç´…åŒ…/ç¦®ç‰©">å…¶ä»–â€“ç´…åŒ…/ç¦®ç‰©</option></optgroup><optgroup label="ğŸ« å„ªæƒ "><option value="å„ªæƒ ">å„ªæƒ  (æŠ˜æ‰£/é»æ•¸)</option></optgroup><optgroup label="ğŸ’° å¹´åº¦æ”¯å‡º"><option value="å¹´åº¦â€“ä¿éšªè²»">å¹´åº¦â€“ä¿éšªè²»</option><option value="å¹´åº¦â€“ç¨…é‡‘">å¹´åº¦â€“ç¨…é‡‘</option><option value="å¹´åº¦â€“å­¸è²»">å¹´åº¦â€“å­¸è²»</option><option value="å¹´åº¦â€“ä¿é¤Šå“">å¹´åº¦â€“ä¿é¤Šå“</option><option value="å¹´åº¦â€“ææ¬¾">å¹´åº¦â€“ææ¬¾</option><option value="å¹´åº¦â€“æ—…éŠ">å¹´åº¦â€“æ—…éŠ</option><option value="å¹´åº¦â€“3Cå®¶é›»">å¹´åº¦â€“3Cå®¶é›»</option><option value="å¹´åº¦â€“å…¶ä»–">å¹´åº¦â€“å…¶ä»–</option></optgroup>`;
    const incomeCategoriesHTML = `<option value="æ”¶å…¥â€“è–ªæ°´">ğŸ’° è–ªæ°´</option><option value="æ”¶å…¥â€“çé‡‘">ğŸ§§ çé‡‘/ç´…åŒ…</option><option value="æ”¶å…¥â€“å…¼è·">ğŸ’¼ å…¼è·/å‰¯æ¥­</option><option value="æ”¶å…¥â€“æŠ•è³‡">ğŸ“ˆ æŠ•è³‡/è‚¡åˆ©</option><option value="æ”¶å…¥â€“å…¶ä»–">âœ¨ å…¶ä»–æ”¶å…¥</option>`;

    // --- On Load ---
    window.onload = function() {
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('modalDate').valueAsDate = new Date();
        toggleType('expense');
        
        if (!API_URL) {
            openSettings();
        } else {
            fetchData();
        }
    };

    // --- API Interactions ---
    function showLoading(text) {
        document.getElementById('loadingOverlay').style.display = 'flex';
        document.getElementById('loadingText').innerText = text || 'è¼‰å…¥ä¸­...';
    }
    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('ocrProgressContainer').style.display = 'none';
    }

    async function fetchData() {
        showLoading('æ­£åœ¨å¾é›²ç«¯è®€å–è³‡æ–™...');
        try {
            // Use POST for reading too, to bypass some strict GET CORS checks in certain environments
            // Passing action in URL as backup, and in body for main logic
            const response = await fetch(`${API_URL}?action=read&t=${Date.now()}`, { 
                method: 'GET', 
                credentials: 'omit'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            transactions = data.sort((a, b) => new Date(b.date) - new Date(a.date));
            renderTable();
            initStatsSelectors();
            updateListFilterOptions();
            hideLoading();
        } catch (e) {
            console.error("Fetch Error:", e);
            hideLoading(); 
            
            if(confirm('âŒ é€£ç·šå¤±æ•—ï¼šç„¡æ³•è®€å–è³‡æ–™ã€‚\n\nè«‹ç¢ºèªï¼š\n1. Apps Script æ˜¯å¦éƒ¨ç½²ç‚ºã€Œä»»ä½•äºº (Anyone)ã€\n2. ç¶²å€æ˜¯å¦æ­£ç¢º (ä»¥ /exec çµå°¾)\n\né»æ“Šã€Œç¢ºå®šã€é‡æ–°æª¢æŸ¥è¨­å®šã€‚')) {
                openSettings();
            }
        }
    }

    // --- Add / Edit Logic ---
    document.getElementById('accountingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.querySelector('input[name="type"]:checked').value;
        const item = {
            date: document.getElementById('date').value,
            type: type,
            category: document.getElementById('category').value,
            description: document.getElementById('description').value,
            amount: parseInt(document.getElementById('cost').value),
            method: document.getElementById('method').value,
            note: document.getElementById('note').value
        };

        if (currentEditingId) {
            item.id = currentEditingId;
            showLoading('æ­£åœ¨æ›´æ–°è³‡æ–™...');
            updateTransactionInSheet(item).then(() => {
                cancelEdit(); 
                hideLoading();
                fetchData();
            });
        } else {
            showLoading('æ­£åœ¨å¯«å…¥é›²ç«¯...');
            addTransactionToSheet(item).then(() => {
                hideLoading();
                const inputMonth = item.date.substring(0, 7);
                const filterSelect = document.getElementById('listFilterMonth');
                updateListFilterOptions();
                filterSelect.value = inputMonth;
                window.currentListPage = 1;
                renderTable();

                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                toggleType(type);
            });
        }
    });

    // é€šç”¨çš„ POST å‡½å¼ - ç”¨æ–¼å¯«å…¥
    async function sendPostRequest(payload) {
        try {
            // å¯«å…¥ä½¿ç”¨ POST + text/plain ç¹é CORS preflight
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', 
                credentials: 'omit',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(payload)
            });
            return true;
        } catch (e) {
            console.error(e);
            alert('é€£ç·šéŒ¯èª¤ï¼šå¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚');
            return false;
        }
    }

    async function addTransactionToSheet(item) {
        if(!item.id) item.id = 'ID_' + Date.now() + Math.random().toString(36).substr(2, 5);
        transactions.unshift(item); 
        transactions.sort((a, b) => new Date(b.date) - new Date(a.date)); 
        await sendPostRequest({ action: 'add', ...item });
    }

    async function updateTransactionInSheet(item) {
        await sendPostRequest({ action: 'edit', ...item });
    }

    async function deleteTransactionFromSheet(id) {
        await sendPostRequest({ action: 'delete', id: id });
    }

    window.editItem = function(id) {
        const item = transactions.find(t => t.id == id);
        if (!item) return;

        currentEditingId = id;
        document.getElementById('date').value = item.date;
        document.querySelector(`input[name="type"][value="${item.type}"]`).click(); 
        
        setTimeout(() => {
            document.getElementById('category').value = item.category;
            document.getElementById('description').value = item.description;
            document.getElementById('cost').value = item.amount;
            document.getElementById('method').value = item.method;
            document.getElementById('note').value = item.note || '';
            
            document.getElementById('btnSubmit').innerText = "ç¢ºèªä¿®æ”¹";
            document.getElementById('btnSubmit').className = "btn-update"; 
            document.getElementById('btnCancelEdit').style.display = "flex"; 
            document.getElementById('inputFormBox').classList.add('editing'); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 50);
    }

    window.cancelEdit = function() {
        currentEditingId = null;
        document.getElementById('accountingForm').reset();
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('btnSubmit').innerText = "æ–°å¢";
        document.getElementById('btnSubmit').className = "btn-add";
        document.getElementById('btnCancelEdit').style.display = "none";
        document.getElementById('inputFormBox').classList.remove('editing');
        document.querySelector(`input[name="type"][value="expense"]`).click();
    }

    window.deleteItem = function(id) {
        if(confirm('ç¢ºå®šè¦å¾é›²ç«¯åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
            showLoading('åˆªé™¤ä¸­...');
            transactions = transactions.filter(t => t.id != id); 
            renderTable();
            
            deleteTransactionFromSheet(id).then(() => {
                hideLoading();
                updateListFilterOptions();
            });
        }
    }
    
    // Settings Logic
    window.openSettings = function() { 
        document.getElementById('settingsModal').style.display = 'block'; 
        document.getElementById('apiUrlInput').value = API_URL; 
    }
    window.closeSettings = function() { document.getElementById('settingsModal').style.display = 'none'; }
    
    // ç¶²å€æª¢æŸ¥èˆ‡å„²å­˜
    function getCleanUrl() {
        let url = document.getElementById('apiUrlInput').value.trim();
        if (!url) return null;
        
        if (url.includes('/edit')) {
            url = url.split('/edit')[0] + '/exec';
        } else if (url.includes('/dev')) {
            alert('âš ï¸ è­¦å‘Šï¼šæ‚¨ä½¿ç”¨çš„æ˜¯æ¸¬è©¦ç‰ˆç¶²å€ (/dev)ï¼Œé€™é€šå¸¸åªæœ‰å»ºç«‹è€…è‡ªå·±èƒ½ç”¨ã€‚\nè«‹ä½¿ç”¨æ­£å¼ç‰ˆ (/exec)ã€‚');
        }
        
        if (!url.endsWith('/exec')) {
            // å˜—è©¦è‡ªå‹•ä¿®å¾©æˆ–è­¦å‘Š
            if (url.includes('/exec')) {
                // å¯èƒ½å¾Œé¢å¸¶äº†åƒæ•¸
                url = url.substring(0, url.indexOf('/exec') + 5);
            }
        }
        return url;
    }

    window.testConnection = async function() {
        const url = getCleanUrl();
        if (!url) { alert('è«‹è¼¸å…¥ç¶²å€'); return; }
        
        const btn = document.querySelector('.btn-test');
        const originalText = btn.innerText;
        btn.innerText = 'â³ æ¸¬è©¦ä¸­...';
        btn.disabled = true;

        try {
            // Use POST for test too
            const response = await fetch(`${url}?action=read&t=${Date.now()}`, { 
                method: 'GET', 
                credentials: 'omit'
            });
            if (response.ok) {
                const data = await response.json();
                alert(`âœ… é€£ç·šæˆåŠŸï¼\nè®€å–åˆ° ${data.length} ç­†è³‡æ–™ã€‚`);
            } else {
                alert(`âŒ é€£ç·šå¤±æ•— (HTTP ${response.status})ã€‚\nè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚`);
            }
        } catch (e) {
            alert(`âŒ é€£ç·šå¤±æ•—ã€‚\néŒ¯èª¤è¨Šæ¯: ${e.message}\n\nè«‹ç¢ºèª Apps Script éƒ¨ç½²æ¬Šé™ç‚ºã€Œä»»ä½•äººã€ã€‚`);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    window.saveSettings = function() {
        const url = getCleanUrl();
        if (url) {
            // åŸºæœ¬æ ¼å¼æª¢æŸ¥
            if (!url.includes('script.google.com')) {
                alert('é€™ä¼¼ä¹ä¸æ˜¯ Google Apps Script çš„ç¶²å€å–”ï¼');
                return;
            }

            API_URL = url;
            localStorage.setItem('myCuteAccountBook_API', API_URL);
            closeSettings();
            fetchData();
        } else {
            alert('è«‹è¼¸å…¥ç¶²å€');
        }
    }

    // Render & Helpers
    function toggleType(type) {
        const select = document.getElementById('category');
        const btnImport = document.getElementById('btnImportReceipt');
        const labelExp = document.getElementById('labelExpense');
        const labelInc = document.getElementById('labelIncome');
        if (type === 'expense') {
            select.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡æ”¯å‡ºåˆ†é¡...</option>` + expenseCategoriesHTML;
            labelExp.classList.add('selected-expense'); labelInc.classList.remove('selected-income');
            btnImport.style.display = 'flex';
        } else {
            select.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡æ”¶å…¥åˆ†é¡...</option>` + incomeCategoriesHTML;
            labelExp.classList.remove('selected-expense'); labelInc.classList.add('selected-income');
            btnImport.style.display = 'none';
        }
    }

    window.switchTab = function(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
        const btnIndex = tabName === 'input' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        if(tabName === 'stats') { initStatsSelectors(); renderStats(); } else { renderTable(); }
    }

    window.updateListFilterOptions = function() {
        const monthSet = new Set();
        const currentMonth = new Date().toISOString().slice(0, 7);
        transactions.forEach(item => monthSet.add(item.date.substring(0, 7)));
        monthSet.add(currentMonth);
        const sortedMonths = Array.from(monthSet).sort().reverse();
        const select = document.getElementById('listFilterMonth');
        const currentVal = select.value;
        select.innerHTML = `<option value="all">é¡¯ç¤ºå…¨éƒ¨</option>`;
        sortedMonths.forEach(m => {
            const opt = document.createElement('option'); opt.value = m; opt.textContent = `${m} æœˆä»½`; select.appendChild(opt);
        });
        if (currentVal === 'all') {} 
        else if (sortedMonths.includes(currentMonth) && currentVal === '') { select.value = currentMonth; }
    }

    window.renderTable = function() {
        const tbody = document.querySelector('#expenseTable tbody'); tbody.innerHTML = '';
        const filterMonth = document.getElementById('listFilterMonth').value;
        let filteredData = transactions;
        if (filterMonth !== 'all') { filteredData = transactions.filter(item => item.date.startsWith(filterMonth)); }

        let mIncome = 0, mExpense = 0;
        
        // --- æ–°å¢ï¼šè¨ˆç®—ä»Šæ—¥èŠ±è²» ---
        const today = new Date().toISOString().slice(0, 10); // å–å¾—ä»Šæ—¥ YYYY-MM-DD
        let todayTotal = 0;
        
        // å¾å…¨éƒ¨è³‡æ–™ä¸­è¨ˆç®—ä»Šæ—¥ï¼Œç¢ºä¿ä¸å—éæ¿¾å™¨å½±éŸ¿
        transactions.forEach(item => {
            if (item.date === today && item.type === 'expense') {
                todayTotal += parseInt(item.amount);
            }
        });
        document.getElementById('dashToday').innerText = `$${todayTotal.toLocaleString()}`;
        // -------------------------

        const label = filterMonth === 'all' ? "ç¸½ç´¯è¨ˆ" : filterMonth;
        document.getElementById('dashLabel').innerText = label;
        document.getElementById('dashLabelExp').innerText = label;

        filteredData.forEach(item => { if (item.type === 'income') mIncome += parseInt(item.amount); else mExpense += parseInt(item.amount); });

        const totalPages = Math.ceil(filteredData.length / itemsPerPage);
        if (window.currentListPage > totalPages) window.currentListPage = 1;
        const pageData = filteredData.slice((window.currentListPage - 1) * itemsPerPage, window.currentListPage * itemsPerPage);

        pageData.forEach(item => {
            const tr = document.createElement('tr');
            const isInc = item.type === 'income';
            // ä¿®æ”¹ 1: åœ¨æœ€å¾Œä¸€å€‹ td åŠ ä¸Š class="action-cell"
            tr.innerHTML = `<td>${item.date}</td><td style="color:${isInc?'#2E7D32':'#c62828'}">${isInc?'ğŸ’° æ”¶å…¥':'ğŸ’¸ æ”¯å‡º'}</td><td>${item.category}</td><td>${item.description}</td><td class="cost-text ${isInc?'cost-income':'cost-expense'}">${isInc?'+':'-'}$${parseInt(item.amount).toLocaleString()}</td><td>${item.method}</td><td style="color:#999;font-size:0.9em">${item.note}</td>
            <td class="action-cell">
                <button class="btn-edit" onclick="editItem('${item.id}')">âœ</button>
                <button class="btn-delete" onclick="deleteItem('${item.id}')">åˆªé™¤</button>
            </td>`;
            tbody.appendChild(tr);
        });

        document.getElementById('dashIncome').innerText = `$${mIncome.toLocaleString()}`;
        document.getElementById('dashExpense').innerText = `$${mExpense.toLocaleString()}`;
        document.getElementById('dashBalance').innerText = `$${(mIncome - mExpense).toLocaleString()}`;
        document.getElementById('dashBalance').style.color = (mIncome - mExpense) >= 0 ? '#1565C0' : '#c62828';
        renderPagination(totalPages);
    }

    function renderPagination(totalPages) {
        const p = document.getElementById('listPagination'); p.innerHTML = ''; if (totalPages <= 1) return;
        const createBtn = (text, page, disabled) => {
            const btn = document.createElement('button'); btn.className = `page-btn ${page === window.currentListPage ? 'active' : ''}`;
            btn.innerText = text; btn.disabled = disabled; btn.onclick = () => { window.currentListPage = page; renderTable(); }; return btn;
        };
        p.appendChild(createBtn('â€¹', window.currentListPage - 1, window.currentListPage === 1));
        let start = Math.max(1, window.currentListPage - 2), end = Math.min(totalPages, start + 4);
        if (end - start < 4) start = Math.max(1, end - 4);
        for (let i = start; i <= end; i++) p.appendChild(createBtn(i, i, false));
        p.appendChild(createBtn('â€º', window.currentListPage + 1, window.currentListPage === totalPages));
    }

    // OCR Logic
    window.handleImageUpload = function(input) {
        if (input.files && input.files[0]) {
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('ocrProgressContainer').style.display = 'block';
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    canvas.width = img.width; canvas.height = img.height; ctx.drawImage(img, 0, 0);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = 0.2126 * data[i] + 0.7152 * data[i + 1] + 0.0722 * data[i + 2];
                        const val = gray > 150 ? 255 : 0; 
                        data[i] = data[i+1] = data[i+2] = val;
                    }
                    ctx.putImageData(imageData, 0, 0);
                    canvas.toBlob(blob => {
                        Tesseract.recognize(blob, 'chi_tra', { logger: m => { if(m.status==='recognizing text') document.getElementById('ocrProgress').style.width = `${Math.round(m.progress*100)}%`; }}).then(({ data: { text } }) => {
                            parseReceiptToTable(text); hideLoading(); input.value = '';
                        });
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    window.parseReceiptToTable = function(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        let foundDate = null, detectedRows = [];
        let isPXMart = text.includes('å…¨è¯') || text.includes('ç¦åˆ©') || text.includes('PX');
        const dateMatch = text.match(/(?:11\d|20\d{2})[-/]\d{1,2}[-/]\d{1,2}/);
        if (dateMatch) {
            let dateStr = dateMatch[0].replace(/\//g, '-');
            if (dateStr.startsWith('11')) { const parts = dateStr.split('-'); dateStr = `${parseInt(parts[0])+1911}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`; }
            try { foundDate = new Date(dateStr).toISOString().split('T')[0]; } catch(e){}
        }
        lines.forEach(line => {
            // ä¿®æ­£é‡é» 1: æ­£è¦åŒ–å…¨å½¢ç©ºç™½ï¼Œä½†ä¸ç§»é™¤æ‰€æœ‰ç©ºç™½
            let cleanLine = line.replace(/[\uff00-\uffef]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xfee0)).trim();
            
            if (cleanLine.match(/ç¸½è¨ˆ|åˆè¨ˆ|æ‡‰ä»˜|å¡è™Ÿ|é›»è©±|ç™¼ç¥¨|æ—¥æœŸ|çµ±ç·¨|ç¨…é¡/)) return;

            // ä¿®æ­£é‡é» 2: ä½¿ç”¨ä¿ç•™ç©ºç™½çš„ Regex é‚è¼¯
            // å°‹æ‰¾æœ€å¾Œä¸€çµ„æ•¸å­—ç•¶ä½œåƒ¹æ ¼
            let priceMatch = cleanLine.match(/\s+(\d+)$/); 
            if (!priceMatch) {
                 // å¦‚æœçœŸçš„æ²’æœ‰ç©ºç™½ï¼Œå˜—è©¦æŠ“å–çµå°¾æ•¸å­—
                 priceMatch = cleanLine.match(/(\d+)$/);
            }
            
            if (priceMatch) {
                let price = priceMatch[1];
                // å–å¾—åƒ¹æ ¼å‰çš„éƒ¨åˆ†ç•¶ä½œã€Œå¯èƒ½åŒ…å«æ•¸é‡çš„åç¨±ã€
                let namePart = cleanLine.substring(0, priceMatch.index).trim();
                
                // ä¿®æ­£é‡é» 3: æª¢æŸ¥åç¨±çµå°¾æ˜¯å¦é‚„æœ‰æ•¸å­—ï¼ˆå³ã€Œæ•¸é‡ã€ï¼‰
                // å¦‚æœåç¨±éƒ¨åˆ†ä»¥ "æ•¸å­—" çµå°¾ï¼Œä¸”è©²æ•¸å­—çœ‹èµ·ä¾†åƒæ•¸é‡ (ä¾‹å¦‚ "1" æˆ– "2")
                let qtyMatch = namePart.match(/\s+(\d+)$/);
                if (qtyMatch) {
                    // ç§»é™¤é€™å€‹æ•¸é‡æ•¸å­—ï¼Œå‰©ä¸‹çš„æ‰æ˜¯çœŸæ­£çš„å“å
                    namePart = namePart.substring(0, qtyMatch.index).trim();
                }
                
                // æœ€å¾Œæ¸…ç†ä¸€ä¸‹å“åä¸­çš„é›œè¨Š
                namePart = namePart.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\(\)\-]/g, ''); 

                if (namePart.length > 1) { // é¿å…åªå‰©ä¸€å€‹å­—
                     detectedRows.push({name: namePart, price: price});
                }
            }
        });
        if(foundDate) document.getElementById('modalDate').value = foundDate;
        document.getElementById('modalMethod').value = isPXMart ? 'PX Pay' : 'ç¾é‡‘';
        document.getElementById('receiptItemsList').innerHTML = '';
        if(detectedRows.length === 0) addNewReceiptRow('å…¨è¯è³¼ç‰©', '', 'é£Ÿâ€“é£Ÿæ');
        else detectedRows.forEach(r => addNewReceiptRow(r.name, r.price, 'é£Ÿâ€“é£Ÿæ'));
        document.getElementById('receiptModal').style.display = 'block';
    }

    window.addNewReceiptRow = function(name='', price='', category='é£Ÿâ€“é£Ÿæ') {
        const div = document.createElement('div'); div.className = 'receipt-row';
        div.innerHTML = `<input type="text" value="${name}" class="item-name"><input type="number" value="${price}" class="item-price"><select class="item-cat">${expenseCategoriesHTML}</select><button class="btn-delete" onclick="this.parentElement.remove()" style="margin:0">X</button>`;
        div.querySelector('.item-cat').value = category;
        document.getElementById('receiptItemsList').appendChild(div);
    }

    window.importReceiptItems = function() {
        const date = document.getElementById('modalDate').value;
        const method = document.getElementById('modalMethod').value;
        const rows = document.querySelectorAll('.receipt-row');
        let count = 0;
        showLoading('æ‰¹æ¬¡åŒ¯å…¥ä¸­...');
        const promises = [];
        rows.forEach(row => {
            const name = row.querySelector('.item-name').value;
            const price = row.querySelector('.item-price').value;
            const cat = row.querySelector('.item-cat').value;
            if(name && price) {
                promises.push(addTransactionToSheet({ date: date, type: 'expense', category: cat, description: name, amount: parseInt(price), method: method, note: 'ç™¼ç¥¨åŒ¯å…¥' }));
                count++;
            }
        });
        Promise.all(promises).then(() => { hideLoading(); alert(`å·²åŒ¯å…¥ ${count} ç­†`); closeModal(); switchTab('input'); fetchData(); });
    }
    window.closeModal = () => document.getElementById('receiptModal').style.display = 'none';
    window.clearForm = function() { if(confirm('ç¢ºå®šè¦æ¸…é™¤è¡¨å–®å…§å®¹å—ï¼Ÿ')) { document.getElementById('accountingForm').reset(); document.getElementById('date').valueAsDate = new Date(); cancelEdit(); } }

    window.initStatsSelectors = function() {
        const yearSelect = document.getElementById('statsYearSelect');
        const currentYear = new Date().getFullYear();
        yearSelect.innerHTML = `<option value="all">æ‰€æœ‰å¹´ä»½</option><option value="${currentYear}">${currentYear}</option>`;
        yearSelect.value = currentYear;
        updateMonthOptions();
    };
    window.updateMonthOptions = function() {
        const monthSelect = document.getElementById('statsMonthSelect');
        monthSelect.innerHTML = '<option value="all">å…¨éƒ¨æœˆä»½</option>';
        for(let i=12; i>=1; i--) monthSelect.innerHTML += `<option value="${i.toString().padStart(2,'0')}">${i}æœˆ</option>`;
        renderStats();
    };
    window.renderStats = function() {
        const selectedYear = document.getElementById('statsYearSelect').value;
        const selectedMonth = document.getElementById('statsMonthSelect').value;
        const excludeLarge = document.getElementById('excludeLarge').checked;
        const statsList = document.getElementById('statsList'); statsList.innerHTML = '';
        let filtered = transactions.filter(t => {
            const y = t.date.substring(0, 4), m = t.date.substring(5, 7);
            if(excludeLarge && t.category.startsWith('å¹´åº¦')) return false;
            if(selectedYear !== 'all' && y !== selectedYear) return false;
            if(selectedMonth !== 'all' && m !== selectedMonth) return false;
            return true;
        });
        if(filtered.length === 0) { statsList.innerHTML = '<div class="empty-state">ç„¡è³‡æ–™</div>'; return; }
        let totals = { income: 0, expense: 0, cats: {} };
        filtered.forEach(t => {
            if(t.type === 'income') totals.income += parseInt(t.amount);
            else { totals.expense += parseInt(t.amount); totals.cats[t.category] = (totals.cats[t.category] || 0) + parseInt(t.amount); }
        });
        document.getElementById('statsTotalIncome').innerText = '$'+totals.income.toLocaleString();
        document.getElementById('statsTotalExpense').innerText = '$'+totals.expense.toLocaleString();
        document.getElementById('statsBalance').innerText = '$'+(totals.income - totals.expense).toLocaleString();
        Object.entries(totals.cats).sort((a,b)=>b[1]-a[1]).forEach(([name, amt]) => {
            const pct = Math.min(100, Math.round(amt / totals.expense * 100));
            statsList.innerHTML += `<div class="stats-card"><div class="stats-row"><span class="category-name">${name}</span><span class="category-amount">$${amt.toLocaleString()}</span></div><div class="stats-row" style="margin-bottom:0"><div class="bar-container"><div class="bar-fill" style="width:${pct}%"></div></div><span style="font-size:0.8em;color:#aaa">${pct}%</span></div></div>`;
        });
    }
    window.toggleExcludeStyle = () => {
        const box = document.getElementById('excludeLarge');
        const lbl = document.getElementById('excludeLabel');
        if(box.checked) { lbl.classList.add('active'); lbl.querySelector('.toggle-icon').innerText = 'ğŸ™ˆ'; }
        else { lbl.classList.remove('active'); lbl.querySelector('.toggle-icon').innerText = 'ğŸ‘ï¸'; }
    }
</script>

</body>
</html>
