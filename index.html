<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æº«é¦¨è¨˜å¸³æœ¬ ğŸ»</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ Tesseract.js ç”¨æ–¼åœ–ç‰‡æ–‡å­—è¾¨è­˜ -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        :root {
            --bg-color: #FFF9F0;
            --card-bg: #FFFFFF;
            --primary-pink: #FFB7B2;
            --secondary-yellow: #FFF2CC;
            --accent-green: #B5EAD7;
            --text-color: #6D4C41;
            --border-radius: 20px;
            --tab-inactive: #FFE0B2;
            --tab-active: #FF9AA2;
            --income-color: #558B2F;
            --expense-color: #FF6F61;
        }

        body {
            font-family: 'Zen Maru Gothic', 'Varela Round', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            /* --- èƒŒæ™¯æ¨£å¼æ›´æ–°ï¼šæ”¹ç‚ºæº«é¦¨æ–¹æ ¼ç­†è¨˜æœ¬é¢¨æ ¼ --- */
            background-image: 
                linear-gradient(#FFE0B2 1px, transparent 1px),
                linear-gradient(90deg, #FFE0B2 1px, transparent 1px);
            background-size: 30px 30px;
            background-attachment: fixed; /* è®“èƒŒæ™¯å›ºå®šï¼Œæ²å‹•æ™‚ä¸æœƒè·Ÿè‘—è·‘ */
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(109, 76, 65, 0.08);
            border: 5px solid white;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 25px;
        }

        h1 {
            color: #FF8B94;
            font-size: 2.5em;
            text-shadow: 2px 2px 0px #FFF2CC;
            margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .mascot {
            font-size: 3.5em;
            display: block;
            margin-bottom: 10px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* åˆ†é å°èˆª */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .tab-btn {
            padding: 12px 35px;
            font-size: 1.2em;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s ease;
            background-color: var(--tab-inactive);
            color: #8D6E63;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
        }

        .tab-btn.active {
            background-color: var(--tab-active);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 154, 162, 0.4);
            transform: translateY(-2px);
        }

        .view-section { display: none; animation: fadeIn 0.5s; }
        .view-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* è¼¸å…¥å€å¡Š */
        .input-box {
            background-color: var(--secondary-yellow);
            padding: 30px;
            border-radius: var(--border-radius);
            border: 3px dashed #FFB7B2;
            margin-bottom: 30px;
            position: relative;
        }

        /* OCR è®€å–ä¸­çš„é®ç½© */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.92);
            border-radius: var(--border-radius);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            text-align: center;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #FF9AA2;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 70%;
            height: 12px;
            background-color: #eee;
            border-radius: 6px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            width: 0%;
            background-color: #B5EAD7;
            transition: width 0.3s;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* æ”¶æ”¯åˆ‡æ›é–‹é—œ (å„ªåŒ–ç‰ˆ) */
        .type-switch-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .type-switch {
            display: flex;
            background: white;
            padding: 5px;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border: 2px solid #FFF;
        }

        .type-option {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2em;
            padding: 10px 30px;
            border-radius: 25px;
            transition: all 0.3s ease;
            color: #aaa;
        }

        .type-option:hover {
            background-color: #f9f9f9;
        }

        .type-option input { display: none; }
        
        .type-option.selected-expense { 
            background-color: #FFCDD2; 
            color: #c62828; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .type-option.selected-income { 
            background-color: #C8E6C9; 
            color: #2E7D32; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* åœ–ç‰‡åŒ¯å…¥æŒ‰éˆ•å€å¡Š */
        .ocr-section {
            margin-bottom: 25px;
            display: block; /* é è¨­é¡¯ç¤ºï¼ŒJSæœƒæ§åˆ¶ */
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .btn-ocr {
            background-color: #B39DDB;
            color: white;
            box-shadow: 0 4px 0 #9575CD;
            width: 100%;
            padding: 12px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        .btn-ocr:hover { background-color: #D1C4E9; transform: translateY(-2px); }
        .btn-ocr:active { transform: scale(0.98); box-shadow: none; transform: translateY(4px); }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #8D6E63;
            font-size: 0.95em;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #FFE0B2;
            border-radius: 15px;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 1rem;
            color: var(--text-color);
            background: white;
            transition: 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #FFB7B2;
            box-shadow: 0 0 0 3px rgba(255, 183, 178, 0.2);
        }

        .btn-group {
            grid-column: 1 / -1;
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px;
            font-size: 1.1em;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
            font-family: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:active { transform: scale(0.98); box-shadow: none !important; transform: translateY(4px) !important; }

        .btn-add { background-color: #FF9AA2; color: white; box-shadow: 0 4px 0 #E57373; }
        .btn-add:hover { background-color: #ff8a93; transform: translateY(-2px); box-shadow: 0 6px 0 #E57373; }
        
        .btn-export { background-color: var(--accent-green); color: #558B2F; box-shadow: 0 4px 0 #81C784; }
        .btn-export:hover { background-color: #a5e0c5; transform: translateY(-2px); box-shadow: 0 6px 0 #81C784; }
        
        .btn-clear { background-color: #ECEFF1; color: #78909C; box-shadow: 0 4px 0 #CFD8DC; flex: 0.3; }
        .btn-clear:hover { background-color: #f5f7f8; transform: translateY(-2px); box-shadow: 0 6px 0 #CFD8DC; }

        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            max-height: 500px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            white-space: nowrap;
            background: white;
        }

        th {
            background-color: #FFDAC1;
            color: #6D4C41;
            padding: 18px 15px;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 1.05em;
        }
        
        td {
            padding: 15px;
            border-bottom: 2px solid #FFF8E1;
            color: #555;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #FFFDE7; }

        .cost-text { font-weight: bold; font-size: 1.1em; }
        .cost-expense { color: var(--expense-color); }
        .cost-income { color: var(--income-color); }

        .summary-dashboard {
            display: flex;
            gap: 15px;
            margin: 0 0 25px 0;
        }

        .summary-card {
            flex: 1;
            padding: 20px 15px;
            border-radius: 20px;
            text-align: center;
            border: 2px solid transparent;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: transform 0.3s;
        }
        
        .summary-card:hover { transform: translateY(-3px); }

        .card-income { background-color: #F1F8E9; color: var(--income-color); border-color: #DCEDC8; }
        .card-expense { background-color: #FFEBEE; color: var(--expense-color); border-color: #FFCDD2; }
        .card-balance { background-color: #E3F2FD; color: #1565C0; border-color: #BBDEFB; }
        
        .summary-label { font-size: 0.95em; opacity: 0.8; margin-bottom: 8px; font-weight: bold; }
        .summary-value { font-size: 1.5em; font-weight: 800; letter-spacing: 0.5px; }

        .btn-delete {
            background-color: #FFEBEE;
            color: #C62828;
            padding: 6px 15px;
            font-size: 0.9em;
            box-shadow: none;
            flex: none;
            width: auto;
            border-radius: 10px;
            transition: 0.2s;
        }
        .btn-delete:hover { background-color: #FFCDD2; }

        /* çµ±è¨ˆé é¢æ¨£å¼ - å„ªåŒ–ç‰ˆ */
        .stats-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            background-color: #FFF2CC;
            padding: 20px 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        
        .control-group { 
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 140px; 
        }

        .control-group-toggle {
            flex: 0 0 auto;
            min-width: auto;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            background-color: #FFF;
            padding: 10px 20px;
            border-radius: 15px;
            border: 2px solid #FFE0B2;
            color: #8D6E63;
            font-weight: bold;
            transition: all 0.3s ease;
            user-select: none;
            height: 50px;
            box-sizing: border-box;
            white-space: nowrap;
        }
        
        .toggle-switch:hover {
            border-color: #FFB7B2;
            background-color: #FFF8E1;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .toggle-switch.active {
            background-color: #FFB7B2;
            color: white;
            border-color: #FF8A80;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toggle-switch input { display: none; }
        .toggle-icon { font-size: 1.3em; }

        .stats-card {
            background: white;
            border: 2px solid #FFF8E1;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .category-name { font-weight: bold; width: 40%; font-size: 1.05em; }
        .bar-container {
            flex: 1;
            background-color: #F5F5F5;
            height: 14px;
            border-radius: 7px;
            margin: 0 15px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background-color: #FFB7B2;
            border-radius: 7px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bar-fill.income-bar { background-color: #AED581; }
        .category-amount { width: 25%; text-align: right; font-weight: bold; font-size: 1.1em; }
        .empty-state { text-align: center; padding: 60px 20px; color: #BBB; font-size: 1.3em; }

        /* --- ç™¼ç¥¨æ˜ç´°ç¢ºèª Modal (å¾®èª¿) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 200; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(60, 40, 40, 0.6); 
            backdrop-filter: blur(8px);
        }

        .modal-content {
            background-color: #FFF;
            margin: 5% auto; 
            padding: 30px;
            border: none;
            border-radius: 25px;
            width: 90%; 
            max-width: 850px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            position: relative;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px dashed #FFE0B2;
            padding-bottom: 15px;
        }
        
        .modal-header h2 {
            color: #8D6E63;
            margin: 0 0 10px 0;
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .receipt-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.5fr 0.5fr;
            gap: 15px;
            margin-bottom: 12px;
            align-items: center;
            padding: 15px;
            background: #FAFAFA;
            border-radius: 15px;
            border: 1px solid #EEE;
            transition: 0.2s;
        }
        
        .receipt-row:hover {
            border-color: #FFCCBC;
            background: #FFFBF7;
        }

        .receipt-row input, .receipt-row select {
            padding: 10px;
            font-size: 0.95em;
            margin: 0;
            border: 1px solid #E0E0E0;
        }

        .receipt-actions {
            margin-top: 25px;
            display: flex;
            gap: 20px;
        }
        
        .btn-confirm {
            background-color: #AED581;
            color: #33691E;
            box-shadow: 0 4px 0 #7CB342;
        }
        .btn-confirm:hover { background-color: #C5E1A5; box-shadow: 0 6px 0 #7CB342; }
        
        .btn-cancel {
            background-color: #FFCCBC;
            color: #BF360C;
            box-shadow: 0 4px 0 #FF8A65;
        }
        .btn-cancel:hover { background-color: #FFAB91; box-shadow: 0 6px 0 #FF8A65; }
        
        .btn-add-row {
            background-color: #E1F5FE;
            color: #0277BD;
            padding: 12px;
            margin-top: 15px;
            width: 100%;
            border-radius: 12px;
            border: 2px dashed #81D4FA;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        .btn-add-row:hover { background-color: #B3E5FC; }

        .receipt-info-bar {
            background-color: #FFF3E0;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <span class="mascot">ğŸ» ğŸ“ ğŸ°</span>
        <h1>æˆ‘çš„å¯æ„›è¨˜å¸³æœ¬</h1>
        <p>è¨˜éŒ„æ¯ä¸€ç­†æ”¶æ”¯ï¼Œç´¯ç©è²¡å¯Œå°ç¢ºå¹¸ï¼</p>
    </header>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('input')">ğŸ“ è¨˜å¸³è¼¸å…¥</button>
        <button class="tab-btn" onclick="switchTab('stats')">ğŸ“Š çµ±è¨ˆå ±è¡¨</button>
    </div>

    <!-- é é¢ 1: è¨˜å¸³è¼¸å…¥ -->
    <div id="view-input" class="view-section active">
        
        <div class="summary-dashboard">
            <div class="summary-card card-income">
                <div class="summary-label">æœ¬æœˆæ”¶å…¥</div>
                <div class="summary-value" id="dashIncome">$0</div>
            </div>
            <div class="summary-card card-expense">
                <div class="summary-label">æœ¬æœˆæ”¯å‡º</div>
                <div class="summary-value" id="dashExpense">$0</div>
            </div>
            <div class="summary-card card-balance">
                <div class="summary-label">æœ¬æœˆçµé¤˜</div>
                <div class="summary-value" id="dashBalance">$0</div>
            </div>
        </div>

        <div class="input-box">
            <!-- Loading é®ç½© -->
            <div id="ocrLoading" class="loading-overlay">
                <div class="spinner"></div>
                <div style="font-weight:bold; color: #7986CB; font-size: 1.3em;">
                    ğŸ” ç™¼ç¥¨åˆ†æä¸­...<br>
                    <span style="font-size:0.7em; color:#888; font-weight: normal;">(æ­£åœ¨å˜—è©¦æ‹†è§£å“é …æ¸…å–®)</span>
                </div>
                <div class="progress-bar">
                    <div id="ocrProgress" class="progress-fill"></div>
                </div>
                <div id="ocrStatusText" style="margin-top:8px; font-size:0.9em; color:#666;">åˆå§‹åŒ–å¼•æ“...</div>
            </div>

            <form id="accountingForm">
                
                <!-- 1. æ”¶æ”¯åˆ‡æ› (æœ€å„ªå…ˆ) -->
                <div class="type-switch-container">
                    <div class="type-switch">
                        <label class="type-option selected-expense" id="labelExpense">
                            <input type="radio" name="type" value="expense" checked onchange="toggleType('expense')">
                            ğŸ’¸ æ”¯å‡º
                        </label>
                        <label class="type-option" id="labelIncome">
                            <input type="radio" name="type" value="income" onchange="toggleType('income')">
                            ğŸ’° æ”¶å…¥
                        </label>
                    </div>
                </div>

                <!-- 2. åŒ¯å…¥åœ–ç‰‡æŒ‰éˆ• (åƒ…åœ¨æ”¯å‡ºæ™‚é¡¯ç¤º) -->
                <div id="ocrSection" class="ocr-section">
                    <input type="file" id="ocrInput" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
                    <button type="button" class="btn-ocr" onclick="document.getElementById('ocrInput').click()">
                        <span>âœ¨</span> åŒ¯å…¥ç™¼ç¥¨ (æ˜ç´°ç¢ºèªç‰ˆ) <span>ğŸ“¸</span>
                    </button>
                </div>

                <!-- 3. è¼¸å…¥è¡¨å–® -->
                <div class="form-grid">
                    <div>
                        <label>ğŸ“… æ—¥æœŸ</label>
                        <input type="date" id="date" required>
                    </div>
                    <div>
                        <label>ğŸ·ï¸ åˆ†é¡é …ç›®</label>
                        <select id="category" required>
                            <!-- é¸é …æœƒç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
                        </select>
                    </div>
                    <div>
                        <label>ğŸ“ èªªæ˜ (å“é …)</label>
                        <input type="text" id="description" placeholder="ä¾‹å¦‚ï¼šé›è…¿é£¯ã€è–ªæ°´..." required>
                    </div>
                    <div>
                        <label>ğŸ’µ é‡‘é¡ (å…ƒ)</label>
                        <input type="number" id="cost" placeholder="0" required>
                    </div>
                    <div>
                        <label>ğŸ’³ æ–¹å¼</label>
                        <select id="method">
                            <option value="ç¾é‡‘">ç¾é‡‘</option>
                            <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                            <option value="è½‰å¸³">è½‰å¸³</option>
                            <option value="è¡Œå‹•æ”¯ä»˜">è¡Œå‹•æ”¯ä»˜</option>
                            <option value="æ‚ éŠå¡">æ‚ éŠå¡</option>
                            <option value="PX Pay">PX Pay</option>
                        </select>
                    </div>
                    <div>
                        <label>ğŸ“Œ å‚™è¨»</label>
                        <input type="text" id="note" placeholder="å‚™è¨»...">
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn-clear" onclick="clearForm()">ğŸ§¹ æ¸…é™¤</button>
                        <button type="submit" class="btn-add">âœ¨ æ–°å¢é€™ä¸€ç­†</button>
                        <button type="button" class="btn-export" onclick="exportToCSV()">ğŸ“¤ åŒ¯å‡º Excel</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="table-container">
            <table id="expenseTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>é¡å‹</th>
                        <th>åˆ†é¡</th>
                        <th>èªªæ˜</th>
                        <th>é‡‘é¡</th>
                        <th>æ–¹å¼</th>
                        <th>å‚™è¨»</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- è³‡æ–™é¡¯ç¤ºå€ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ç™¼ç¥¨ç¢ºèª Modal -->
    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ§¾ ç™¼ç¥¨æ˜ç´°ç¢ºèª</h2>
                <p>è«‹æª¢æŸ¥ä¸‹æ–¹è¾¨è­˜çµæœï¼Œä¿®æ­£éŒ¯èª¤ä¸¦åˆªé™¤å¤šé¤˜é …ç›®</p>
            </div>
            
            <div class="receipt-info-bar">
                <div style="flex:1;">
                    <label>ç™¼ç¥¨æ—¥æœŸ</label>
                    <input type="date" id="modalDate">
                </div>
                <div style="flex:1;">
                    <label>ä»˜æ¬¾æ–¹å¼</label>
                    <select id="modalMethod">
                        <option value="ç¾é‡‘">ç¾é‡‘</option>
                        <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡</option>
                        <option value="PX Pay">PX Pay</option>
                        <option value="æ‚ éŠå¡">æ‚ éŠå¡</option>
                    </select>
                </div>
            </div>

            <div class="modal-body">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1.5fr 0.5fr; gap:10px; padding:0 10px; font-weight:bold; color:#888; margin-bottom:5px;">
                    <span>å“é …èªªæ˜</span>
                    <span>é‡‘é¡</span>
                    <span>åˆ†é¡</span>
                    <span>åˆªé™¤</span>
                </div>
                <div id="receiptItemsList">
                    <!-- JS å‹•æ…‹ç”¢ç”Ÿé …ç›® -->
                </div>
                <button type="button" class="btn-add-row" onclick="addNewReceiptRow()">+ æ‰‹å‹•æ–°å¢ä¸€åˆ—</button>
            </div>

            <div class="receipt-actions">
                <button class="btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn-confirm" onclick="importReceiptItems()">âœ… ç¢ºèªåŒ¯å…¥è¨˜å¸³æœ¬</button>
            </div>
        </div>
    </div>

    <!-- é é¢ 2: çµ±è¨ˆå ±è¡¨ -->
    <div id="view-stats" class="view-section">
        <div class="stats-controls">
            <div class="control-group">
                <label>ğŸ“… é¸æ“‡å¹´ä»½ï¼š</label>
                <select id="statsYearSelect" onchange="updateMonthOptions()"></select>
            </div>
            <div class="control-group">
                <label>ğŸ—“ï¸ é¸æ“‡æœˆä»½ï¼š</label>
                <select id="statsMonthSelect" onchange="renderStats()">
                    <option value="all">å…¨éƒ¨æœˆä»½</option>
                </select>
            </div>
            <!-- å„ªåŒ–å¾Œçš„æ’é™¤æŒ‰éˆ• -->
            <div class="control-group-toggle">
                 <label class="toggle-switch" id="excludeLabel">
                    <input type="checkbox" id="excludeLarge" onchange="toggleExcludeStyle(); renderStats()">
                    <span class="toggle-icon">ğŸ‘ï¸</span>
                    <span>æ’é™¤å¹´åº¦æ”¯å‡º</span>
                </label>
            </div>
        </div>

        <div class="summary-dashboard">
            <div class="summary-card card-income">
                <div class="summary-label">ç¸½æ”¶å…¥</div>
                <div class="summary-value" id="statsTotalIncome">$0</div>
            </div>
            <div class="summary-card card-expense">
                <div class="summary-label">ç¸½æ”¯å‡º</div>
                <div class="summary-value" id="statsTotalExpense">$0</div>
            </div>
            <div class="summary-card card-balance">
                <div class="summary-label">ç¸½çµé¤˜</div>
                <div class="summary-value" id="statsBalance">$0</div>
            </div>
        </div>

        <div id="statsList"></div>
    </div>
</div>

<script>
    // --- åˆ†é¡è³‡æ–™ ---
    const expenseCategoriesHTML = `
        <optgroup label="ğŸ” é£Ÿ">
            <option value="é£Ÿâ€“æ—©é¤">é£Ÿâ€“æ—©é¤</option>
            <option value="é£Ÿâ€“åˆé¤">é£Ÿâ€“åˆé¤</option>
            <option value="é£Ÿâ€“æ™šé¤">é£Ÿâ€“æ™šé¤</option>
            <option value="é£Ÿâ€“æ—©åˆèŒ¶">é£Ÿâ€“æ—©åˆèŒ¶</option>
            <option value="é£Ÿâ€“é»å¿ƒ">é£Ÿâ€“é»å¿ƒ</option>
            <option value="é£Ÿâ€“é£²æ–™">é£Ÿâ€“é£²æ–™</option>
            <option value="é£Ÿâ€“é£Ÿæ" selected>é£Ÿâ€“é£Ÿæ</option>
        </optgroup>
        <optgroup label="ğŸ‘— è¡£">
            <option value="è¡£â€“é‹è¥ª/åŒ…åŒ…/è¡£æœ">è¡£â€“é‹è¥ª/åŒ…åŒ…/è¡£æœ</option>
        </optgroup>
        <optgroup label="ğŸ’‡â€â™€ï¸ ç¾">
            <option value="ç¾â€“ç¾é«®">ç¾â€“ç¾é«®</option>
            <option value="ç¾â€“ä¿é¤Šå“">ç¾â€“ä¿é¤Šå“</option>
        </optgroup>
        <optgroup label="ğŸ  ä½">
            <option value="ä½â€“æ‰‹æ©Ÿè²»">ä½â€“æ‰‹æ©Ÿè²»</option>
        </optgroup>
        <optgroup label="ğŸš— è¡Œ">
            <option value="è¡Œâ€“ç¶­ä¿®/åœè»Š">è¡Œâ€“ç¶­ä¿®/åœè»Š</option>
            <option value="è¡Œâ€“åŠ æ²¹">è¡Œâ€“åŠ æ²¹</option>
        </optgroup>
        <optgroup label="âœï¸ è‚²">
            <option value="è‚²â€“æ–‡å…·">è‚²â€“æ–‡å…·</option>
            <option value="è‚²â€“æ›¸/ä¸Šèª²å­¸ç¿’">è‚²â€“æ›¸/ä¸Šèª²å­¸ç¿’</option>
        </optgroup>
        <optgroup label="ğŸ¡ æ¨‚">
            <option value="æ¨‚â€“ä½å®¿/é–€ç¥¨/äº¤é€š">æ¨‚â€“ä½å®¿/é–€ç¥¨/äº¤é€š</option>
        </optgroup>
        <optgroup label="ğŸ‘¶ BABY">
            <option value="BABY-è¡£ç‰©">BABY-è¡£ç‰©</option>
            <option value="BABY-ç”¨ç‰©">BABY-ç”¨ç‰©</option>
            <option value="BABY-é†«ç™‚">BABY-é†«ç™‚</option>
        </optgroup>
        <optgroup label="ğŸ›’ å…¶ä»–">
            <option value="å…¶ä»–â€“æ—¥ç”¨é›œè²¨" selected>å…¶ä»–â€“æ—¥ç”¨é›œè²¨</option>
            <option value="å…¶ä»–â€“æ—¥ç”¨é›œè²¨(å®¶ç”¨)">å…¶ä»–â€“æ—¥ç”¨é›œè²¨(å®¶ç”¨)</option>
            <option value="å…¶ä»–â€“é†«ç™‚">å…¶ä»–â€“é†«ç™‚</option>
            <option value="å…¶ä»–â€“ç´…åŒ…/ç¦®ç‰©">å…¶ä»–â€“ç´…åŒ…/ç¦®ç‰©</option>
        </optgroup>
        <optgroup label="ğŸ« å„ªæƒ ">
            <option value="å„ªæƒ ">å„ªæƒ  (æŠ˜æ‰£/é»æ•¸)</option>
        </optgroup>
        <optgroup label="ğŸ’° å¹´åº¦æ”¯å‡º">
            <option value="å¹´åº¦â€“ä¿éšªè²»">å¹´åº¦â€“ä¿éšªè²»</option>
            <option value="å¹´åº¦â€“ç¨…é‡‘">å¹´åº¦â€“ç¨…é‡‘</option>
            <option value="å¹´åº¦â€“å­¸è²»">å¹´åº¦â€“å­¸è²»</option>
            <option value="å¹´åº¦â€“ä¿é¤Šå“">å¹´åº¦â€“ä¿é¤Šå“</option>
            <option value="å¹´åº¦â€“ææ¬¾">å¹´åº¦â€“ææ¬¾</option>
            <option value="å¹´åº¦â€“æ—…éŠ">å¹´åº¦â€“æ—…éŠ</option>
            <option value="å¹´åº¦â€“3Cå®¶é›»">å¹´åº¦â€“3Cå®¶é›»</option>
            <option value="å¹´åº¦â€“å…¶ä»–">å¹´åº¦â€“å…¶ä»–</option>
        </optgroup>
    `;

    const incomeCategoriesHTML = `
        <option value="æ”¶å…¥â€“è–ªæ°´">ğŸ’° è–ªæ°´</option>
        <option value="æ”¶å…¥â€“çé‡‘">ğŸ§§ çé‡‘/ç´…åŒ…</option>
        <option value="æ”¶å…¥â€“å…¼è·">ğŸ’¼ å…¼è·/å‰¯æ¥­</option>
        <option value="æ”¶å…¥â€“æŠ•è³‡">ğŸ“ˆ æŠ•è³‡/è‚¡åˆ©</option>
        <option value="æ”¶å…¥â€“å…¶ä»–">âœ¨ å…¶ä»–æ”¶å…¥</option>
    `;

    // --- åŸºç¤è¨­å®š ---
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('modalDate').valueAsDate = new Date();
    let transactions = []; 

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        const storedNew = localStorage.getItem('myCuteTransactions');
        const storedOld = localStorage.getItem('myCuteExpenses');

        if (storedNew) {
            transactions = JSON.parse(storedNew);
        } else if (storedOld) {
            const oldData = JSON.parse(storedOld);
            transactions = oldData.map(item => ({
                ...item,
                type: 'expense', 
                amount: item.cost 
            }));
            localStorage.setItem('myCuteTransactions', JSON.stringify(transactions));
        }

        toggleType('expense'); // é è¨­æ”¯å‡ºï¼Œæœƒè§¸ç™¼é¡¯ç¤ºåŒ¯å…¥æŒ‰éˆ•
        renderTable();
        initStatsSelectors();
    }

    // --- æŒ‰éˆ•æ¨£å¼åˆ‡æ› ---
    function toggleExcludeStyle() {
        const checkbox = document.getElementById('excludeLarge');
        const label = document.getElementById('excludeLabel');
        if(checkbox.checked) {
            label.classList.add('active');
            label.querySelector('.toggle-icon').innerText = 'ğŸ™ˆ';
        } else {
            label.classList.remove('active');
            label.querySelector('.toggle-icon').innerText = 'ğŸ‘ï¸';
        }
    }

    // --- OCR åœ–ç‰‡è¾¨è­˜åŠŸèƒ½ (å‡ç´šç‰ˆ) ---
    function handleImageUpload(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const loading = document.getElementById('ocrLoading');
            const progressFill = document.getElementById('ocrProgress');
            const statusText = document.getElementById('ocrStatusText');
            
            loading.style.display = 'flex';
            progressFill.style.width = '5%';
            statusText.innerText = "æ­£åœ¨è™•ç†åœ–ç‰‡...";

            preprocessImage(file, (processedBlob) => {
                statusText.innerText = "OCR å¼•æ“å•Ÿå‹•ä¸­...";
                progressFill.style.width = '20%';

                Tesseract.recognize(
                    processedBlob,
                    'chi_tra', 
                    { 
                        logger: m => {
                            if(m.status === 'recognizing text') {
                                progressFill.style.width = `${Math.round(m.progress * 100)}%`;
                                statusText.innerText = `è¾¨è­˜æ–‡å­—ä¸­... ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                ).then(({ data: { text } }) => {
                    progressFill.style.width = '100%';
                    statusText.innerText = "åˆ†æå®Œæˆï¼Œé–‹å•Ÿç¢ºèªè¦–çª—...";
                    
                    setTimeout(() => {
                        loading.style.display = 'none';
                        parseReceiptToTable(text); 
                        input.value = ''; 
                    }, 500);

                }).catch(err => {
                    console.error(err);
                    alert('è¾¨è­˜å¤±æ•— > < \nå»ºè­°å°‡åœ–ç‰‡è£åˆ‡è‡³åªæœ‰æ–‡å­—éƒ¨åˆ†å†è©¦ä¸€æ¬¡ã€‚');
                    loading.style.display = 'none';
                });
            });
        }
    }

    // å½±åƒé è™•ç† (é»‘ç™½åŒ–)
    function preprocessImage(file, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i + 1], b = data[i + 2];
                    const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b;
                    const val = gray > 150 ? 255 : 0; 
                    data[i] = data[i + 1] = data[i + 2] = val;
                }
                ctx.putImageData(imageData, 0, 0);
                canvas.toBlob(callback, 'image/png');
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // --- æ–°åŠŸèƒ½ï¼šè§£æç™¼ç¥¨ä¸¦é–‹å•Ÿ Modal ---
    function parseReceiptToTable(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        let foundDate = null;
        let detectedRows = [];
        let isPXMart = text.includes('å…¨è¯') || text.includes('ç¦åˆ©') || text.includes('PX');

        // 1. æŠ“æ—¥æœŸ
        const dateRegex = /(?:11\d|20\d{2})[-/]\d{1,2}[-/]\d{1,2}/;
        const dateMatch = text.match(dateRegex);
        if (dateMatch) {
            let dateStr = dateMatch[0].replace(/\//g, '-');
            if (dateStr.startsWith('11')) {
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const year = parseInt(parts[0]) + 1911;
                    dateStr = `${year}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
                }
            }
            try {
                const d = new Date(dateStr);
                if (!isNaN(d.getTime())) {
                    foundDate = d.toISOString().split('T')[0];
                }
            } catch(e) {}
        }

        // 2. æŠ“å“é …èˆ‡é‡‘é¡ (æ‹†è§£é‚è¼¯)
        let skipKeywords = ['é›»è©±', 'å…¨è¯', 'ç¦åˆ©', 'ç™¼ç¥¨', 'æ—¥æœŸ', 'åº—è™Ÿ', 'æ©Ÿè™Ÿ', 'åºè™Ÿ', 'ç¸½è¨ˆ', 'åˆè¨ˆ', 'ä¿¡ç”¨å¡', 'æ‰¾é›¶', 'çµ±ä¸€ç·¨è™Ÿ', 'å¡è™Ÿ', 'TX', 'å„²å€¼', 'é»æ•¸', 'æ¶ˆè²»', 'é‡‘é¡', 'æ‡‰ä»˜'];
        
        lines.forEach(line => {
            let cleanLine = line.trim();
            
            if (skipKeywords.some(kw => cleanLine.includes(kw))) return;
            if (cleanLine.match(/^\d{3,}[-\/]/)) return; 
            if (cleanLine.match(/^\d{8,}$/)) return;

            let match = cleanLine.match(/^(.*?)\s+(\d+)\s*[A-Z]*$/);
            
            if (!match && /[\u4e00-\u9fa5]/.test(cleanLine) && /\d+$/.test(cleanLine)) {
                let priceMatch = cleanLine.match(/(\d+)\s*[A-Z]*$/);
                if (priceMatch) {
                    let price = priceMatch[1];
                    let name = cleanLine.substring(0, cleanLine.lastIndexOf(price)).trim();
                    match = [null, name, price]; 
                }
            }

            if (match) {
                let name = match[1].trim();
                let price = match[2];

                // å»é™¤ç·¨è™Ÿã€å°¾éƒ¨é›œè¨Šã€ç©ºç™½
                name = name.replace(/^[\d]+\s*[.]?\s*/, '');
                name = name.replace(/[A-Z]+$/, '').trim();
                name = name.replace(/\s+/g, '');

                if (name.length > 1 && price.length < 6) {
                    detectedRows.push({ name, price });
                }
            }
        });

        if (foundDate) document.getElementById('modalDate').value = foundDate;
        document.getElementById('modalMethod').value = isPXMart ? 'PX Pay' : 'ç¾é‡‘';

        const listDiv = document.getElementById('receiptItemsList');
        listDiv.innerHTML = '';
        
        if (detectedRows.length === 0) {
            addNewReceiptRow('å…¨è¯è³¼ç‰©', '', 'é£Ÿâ€“é£Ÿæ');
        } else {
            detectedRows.forEach(row => {
                let defaultCat = 'é£Ÿâ€“é£Ÿæ';
                if(row.name.includes('ç´™') || row.name.includes('å·¾') || row.name.includes('åˆ·')) {
                    defaultCat = 'å…¶ä»–â€“æ—¥ç”¨é›œè²¨';
                }
                addNewReceiptRow(row.name, row.price, defaultCat);
            });
        }

        document.getElementById('receiptModal').style.display = 'block';
    }

    function addNewReceiptRow(name = '', price = '', category = 'é£Ÿâ€“é£Ÿæ') {
        const listDiv = document.getElementById('receiptItemsList');
        const div = document.createElement('div');
        div.className = 'receipt-row';
        div.innerHTML = `
            <input type="text" value="${name}" placeholder="å“é …åç¨±" class="item-name">
            <input type="number" value="${price}" placeholder="é‡‘é¡" class="item-price">
            <select class="item-cat">
                ${expenseCategoriesHTML}
            </select>
            <button class="btn-delete" onclick="this.parentElement.remove()" style="margin:0;">X</button>
        `;
        div.querySelector('.item-cat').value = category;
        listDiv.appendChild(div);
    }

    function closeModal() {
        document.getElementById('receiptModal').style.display = 'none';
    }

    function importReceiptItems() {
        const date = document.getElementById('modalDate').value;
        const method = document.getElementById('modalMethod').value;
        const rows = document.querySelectorAll('.receipt-row');
        
        let count = 0;
        rows.forEach(row => {
            const name = row.querySelector('.item-name').value;
            const price = row.querySelector('.item-price').value;
            const category = row.querySelector('.item-cat').value;

            if (name && price) {
                const newTrans = {
                    id: Date.now() + count, 
                    date: date,
                    type: 'expense', 
                    category: category,
                    description: name,
                    amount: parseInt(price),
                    method: method,
                    note: 'ç™¼ç¥¨åŒ¯å…¥'
                };
                transactions.push(newTrans);
                count++;
            }
        });

        if (count > 0) {
            saveAndRender();
            alert(`æˆåŠŸåŒ¯å…¥ ${count} ç­†æ¬¾é …ï¼`);
            closeModal();
            switchTab('input');
        } else {
            alert('æ²’æœ‰æœ‰æ•ˆçš„é …ç›®å¯ä»¥åŒ¯å…¥å–”ï¼è«‹æª¢æŸ¥é‡‘é¡æ˜¯å¦å¡«å¯«ã€‚');
        }
    }

    function toggleType(type) {
        const select = document.getElementById('category');
        const labelExp = document.getElementById('labelExpense');
        const labelInc = document.getElementById('labelIncome');
        const ocrSection = document.getElementById('ocrSection');

        if (type === 'expense') {
            select.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡æ”¯å‡ºåˆ†é¡...</option>` + expenseCategoriesHTML;
            labelExp.classList.add('selected-expense');
            labelInc.classList.remove('selected-income');
            // æ”¯å‡ºæ™‚é¡¯ç¤ºåŒ¯å…¥æŒ‰éˆ•
            ocrSection.style.display = 'block';
        } else {
            select.innerHTML = `<option value="" disabled selected>è«‹é¸æ“‡æ”¶å…¥åˆ†é¡...</option>` + incomeCategoriesHTML;
            labelExp.classList.remove('selected-expense');
            labelInc.classList.add('selected-income');
            // æ”¶å…¥æ™‚éš±è—åŒ¯å…¥æŒ‰éˆ•
            ocrSection.style.display = 'none';
        }
    }

    function switchTab(tabName) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`view-${tabName}`).classList.add('active');
        const btnIndex = tabName === 'input' ? 0 : 1;
        document.querySelectorAll('.tab-btn')[btnIndex].classList.add('active');
        if(tabName === 'stats') { initStatsSelectors(); renderStats(); } else { renderTable(); }
    }

    document.getElementById('accountingForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const type = document.querySelector('input[name="type"]:checked').value;
        const newTrans = {
            id: Date.now(),
            date: document.getElementById('date').value,
            type: type,
            category: document.getElementById('category').value,
            description: document.getElementById('description').value,
            amount: parseInt(document.getElementById('cost').value),
            method: document.getElementById('method').value,
            note: document.getElementById('note').value
        };
        transactions.push(newTrans);
        saveAndRender();
        this.reset();
        document.getElementById('date').valueAsDate = new Date();
    });

    function saveAndRender() {
        transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
        localStorage.setItem('myCuteTransactions', JSON.stringify(transactions));
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector('#expenseTable tbody');
        tbody.innerHTML = '';
        let monthIncome = 0;
        let monthExpense = 0;
        const currentYearMonth = new Date().toISOString().slice(0, 7);
        transactions.forEach(item => {
            if (item.date.startsWith(currentYearMonth)) {
                if (item.type === 'income') monthIncome += item.amount;
                else monthExpense += item.amount;
            }
            const tr = document.createElement('tr');
            const isIncome = item.type === 'income';
            tr.innerHTML = `
                <td>${item.date}</td>
                <td style="font-size:0.9em; color:${isIncome?'#2E7D32':'#c62828'}">${isIncome ? 'ğŸ’° æ”¶å…¥' : 'ğŸ’¸ æ”¯å‡º'}</td>
                <td>${item.category}</td>
                <td>${item.description}</td>
                <td class="cost-text ${isIncome ? 'cost-income' : 'cost-expense'}">${isIncome ? '+' : '-'}$${item.amount.toLocaleString()}</td>
                <td>${item.method}</td>
                <td style="color: #999; font-size: 0.9em;">${item.note}</td>
                <td><button class="btn-delete" onclick="deleteItem(${item.id})">åˆªé™¤</button></td>
            `;
            tbody.appendChild(tr);
        });
        document.getElementById('dashIncome').innerText = `$${monthIncome.toLocaleString()}`;
        document.getElementById('dashExpense').innerText = `$${monthExpense.toLocaleString()}`;
        const balance = monthIncome - monthExpense;
        document.getElementById('dashBalance').innerText = `$${balance.toLocaleString()}`;
        document.getElementById('dashBalance').style.color = balance >= 0 ? '#1565C0' : '#c62828';
    }

    function deleteItem(id) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼ŸğŸ¥º')) {
            transactions = transactions.filter(item => item.id !== id);
            saveAndRender();
        }
    }

    function clearForm() {
        if(confirm('ç¢ºå®šè¦æ¸…é™¤è¡¨å–®å…§å®¹å—ï¼Ÿ')) {
            document.getElementById('accountingForm').reset();
            document.getElementById('date').valueAsDate = new Date();
        }
    }

    function exportToCSV() {
        if (transactions.length === 0) { alert("é‚„æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡ºå–”ï¼"); return; }
        let csvContent = "\uFEFFæ—¥æœŸ,é¡å‹,åˆ†é¡é …ç›®,èªªæ˜,é‡‘é¡,æ–¹å¼,å‚™è¨»\n";
        transactions.forEach(item => {
            let row = [
                item.date,
                item.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                `"${item.category}"`, 
                `"${item.description}"`,
                item.type === 'income' ? item.amount : -item.amount,
                item.method,
                `"${item.note}"`
            ].join(",");
            csvContent += row + "\n";
        });
        const today = new Date().toISOString().split('T')[0];
        const filename = `è¨˜å¸³æœ¬åŒ¯å‡º_${today}.csv`;
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function initStatsSelectors() {
        const yearSet = new Set();
        const currentYear = new Date().getFullYear().toString();
        transactions.forEach(item => yearSet.add(item.date.substring(0, 4)));
        yearSet.add(currentYear);
        const sortedYears = Array.from(yearSet).sort().reverse();
        const yearSelect = document.getElementById('statsYearSelect');
        const currentVal = yearSelect.value;
        yearSelect.innerHTML = '<option value="all">ğŸ“… æ‰€æœ‰å¹´ä»½</option>';
        sortedYears.forEach(y => {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = `${y} å¹´`;
            yearSelect.appendChild(opt);
        });
        if (currentVal && Array.from(yearSelect.options).some(o => o.value === currentVal)) yearSelect.value = currentVal; else yearSelect.value = currentYear;
        updateMonthOptions();
    }

    function updateMonthOptions() {
        const year = document.getElementById('statsYearSelect').value;
        const monthSelect = document.getElementById('statsMonthSelect');
        const currentVal = monthSelect.value;
        monthSelect.innerHTML = '<option value="all">ğŸ—“ï¸ å…¨å¹´æœˆä»½</option>';
        if (year !== 'all') {
            monthSelect.disabled = false;
            for(let i=12; i>=1; i--) {
                const m = i.toString().padStart(2, '0');
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = `${m} æœˆ`;
                monthSelect.appendChild(opt);
            }
        } else { monthSelect.disabled = true; }
        if (currentVal && !monthSelect.disabled) monthSelect.value = currentVal;
        renderStats();
    }

    function renderStats() {
        const selectedYear = document.getElementById('statsYearSelect').value;
        const selectedMonth = document.getElementById('statsMonthSelect').value;
        const excludeLarge = document.getElementById('excludeLarge').checked;
        const statsList = document.getElementById('statsList');
        statsList.innerHTML = '';
        let filteredData = transactions.filter(item => {
            const y = item.date.substring(0, 4);
            const m = item.date.substring(5, 7);
            
            // æ’é™¤å¹´åº¦æ”¯å‡º
            if (excludeLarge && item.category.startsWith('å¹´åº¦')) return false;

            if (selectedYear !== 'all' && y !== selectedYear) return false;
            if (selectedMonth !== 'all' && m !== selectedMonth) return false;
            return true;
        });
        let totalIncome = 0; let totalExpense = 0; const categoryTotals = {};
        filteredData.forEach(item => {
            if (item.type === 'income') totalIncome += item.amount; else totalExpense += item.amount;
            if (!categoryTotals[item.category]) categoryTotals[item.category] = { amount: 0, type: item.type };
            categoryTotals[item.category].amount += item.amount;
        });
        document.getElementById('statsTotalIncome').innerText = `$${totalIncome.toLocaleString()}`;
        document.getElementById('statsTotalExpense').innerText = `$${totalExpense.toLocaleString()}`;
        const balance = totalIncome - totalExpense;
        document.getElementById('statsBalance').innerText = `$${balance.toLocaleString()}`;
        document.getElementById('statsBalance').style.color = balance >= 0 ? '#1565C0' : '#c62828';
        if (filteredData.length === 0) { statsList.innerHTML = '<div class="empty-state">é€™è£¡é‚„æ²’æœ‰è³‡æ–™å–” ğŸƒ</div>'; return; }
        const sortedCategories = Object.entries(categoryTotals).sort(([,a], [,b]) => b.amount - a.amount);
        sortedCategories.forEach(([name, data]) => {
            const isIncome = data.type === 'income';
            const base = isIncome ? totalIncome : totalExpense;
            const percent = base > 0 ? Math.min((data.amount / base) * 100, 100) : 0;
            const div = document.createElement('div');
            div.className = 'stats-card';
            div.innerHTML = `
                <div class="stats-row"><span class="category-name">${name}</span><span class="category-amount" style="color: ${isIncome ? 'var(--income-color)' : 'var(--expense-color)'}">${isIncome ? '+' : '-'}$${data.amount.toLocaleString()}</span></div>
                <div class="stats-row" style="margin-bottom:0;"><div class="bar-container"><div class="bar-fill ${isIncome ? 'income-bar' : ''}" style="width: ${percent}%;"></div></div><span style="font-size: 0.8em; color: #aaa; width: 40px; text-align:right;">${Math.round(percent)}%</span></div>
            `;
            statsList.appendChild(div);
        });
    }
</script>

</body>
</html>
